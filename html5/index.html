<script src="Loader.js"></script>

<script>

	function fetch_script(url) {
		return new Promise(function(resolve, reject) {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.onload = function () {
				resolve(script);
			};
			script.src = url /* + "?now=" + Date.now()*/;
			document.head.appendChild(script);
		});
	}

	async function main() {
		response = await fetch("../build/untouched.wasm");
		//buffer = await response.arrayBuffer();
		
		imports = {};
		
		/*
		imports.env = {};
		imports.env.memoryBase = 0;
		imports.env.tableBase = 0;
		if (!imports.env.memory) {
			imports.env.memory = new WebAssembly.Memory({ initial: 20 });
		}
		if (!imports.env.table) {
			imports.env.table = new WebAssembly.Table({ initial: 0, element: 'anyfunc' });
		}
		*/
		
		//module = Loader.instantiateBuffer(buffer, imports);
		module = await Loader.instantiateStreaming(response, imports);
		
		//console.log(module.I8.length);
		
		// next three lines just test the auto-generated demangled class, which isn't so useful currently
		a = new module.Vec3(1,2,3)
		b = new module.Vec3(11,22,33)
		console.log("a.add(b)", a.add(b)); // returns no class but a raw pointer
		
		pc = {}; // namespace for all pc_*.js files
		await fetch_script("pc_mat3.js");
		await fetch_script("pc_mat4.js");
		await fetch_script("pc_quat.js");
		await fetch_script("pc_vec2.js");
		await fetch_script("pc_vec3.js");
		await fetch_script("pc_vec4.js");
		
		
		mat3_a = new pc.Mat4();
		mat3_b = new pc.Mat4();
		mat3_c = new pc.Mat4();
		
		mat4_a = new pc.Mat4();
		mat4_b = new pc.Mat4();
		mat4_c = new pc.Mat4();
		
		quat_a = new pc.Quat();
		quat_b = new pc.Quat();
		quat_c = new pc.Quat();
		
		vec2_a = new pc.Vec3(1, 2);
		vec2_b = new pc.Vec3(11, 22);
		vec2_c = new pc.Vec3(111, 222);
		
		vec3_a = new pc.Vec3(1, 2, 3);
		vec3_b = new pc.Vec3(11, 22, 33);
		vec3_c = new pc.Vec3(111, 222, 333);
		
		vec4_a = new pc.Vec3(1, 2, 3, 4);
		vec4_b = new pc.Vec3(11, 22, 33, 44);
		vec4_c = new pc.Vec3(111, 222, 333, 444);
		
	}

	main().then(function() {
		console.log("main() called");
	});

</script>