<script src="Loader.js"></script>

<script>

	function fetch_script(url) {
		return new Promise(function(resolve, reject) {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.onload = function () {
				resolve(script);
			};
			script.src = url /* + "?now=" + Date.now()*/;
			document.head.appendChild(script);
		});
	}

	async function main() {
		response = await fetch("../build/untouched.wasm");
		//buffer = await response.arrayBuffer();
		
		imports = {};
		
		/*
		imports.env = {};
		imports.env.memoryBase = 0;
		imports.env.tableBase = 0;
		if (!imports.env.memory) {
			imports.env.memory = new WebAssembly.Memory({ initial: 20 });
		}
		if (!imports.env.table) {
			imports.env.table = new WebAssembly.Table({ initial: 0, element: 'anyfunc' });
		}
		*/
		
		//module = Loader.instantiateBuffer(buffer, imports);
		module = await Loader.instantiateStreaming(response, imports);
		
		//console.log(module.I8.length);
		
		// next three lines just test the auto-generated demangled class, which isn't so useful currently
		a = new module.Vec3(1,2,3)
		b = new module.Vec3(11,22,33)
		console.log("a.add(b)", a.add(b)); // returns no class but a raw pointer
		
		// namespace for all pc_*.js files
		pc = {};
		await fetch_script("pc_vec3.js");
		await fetch_script("pc_mat4.js");
		
		vec_a = new pc.Vec3(1, 2, 3);
		vec_b = new pc.Vec3(4, 5, 6);
		console.log(vec_a, vec_b);
		vec_c = (new pc.Vec3()).add2(vec_a, vec_b);
		console.log(vec_c);
		
		mat_a = new pc.Mat4();
		mat_b = new pc.Mat4();
		mat_c = new pc.Mat4();
		mat_c.add2(mat_a, mat_b);
		console.log(mat_c);
	}

	main().then(function() {
		console.log("main() called");
	});

</script>